<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>时光泰坦重铸 副本掉落查询</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Microsoft YaHei", "PingFang SC", Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1b1b2f 0, #050509 45%, #020308 100%);
      color: #f5f4e8;
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
    }

    .panel {
      width: 100%;
      max-width: 1200px;
      background: rgba(5, 4, 10, 0.92);
      border: 2px solid #c79c37;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.85);
      padding: 24px 28px 28px;
      position: relative;
      overflow: hidden;
    }

    .panel::before,
    .panel::after {
      content: "";
      position: absolute;
      border: 1px solid rgba(255, 215, 128, 0.45);
      pointer-events: none;
    }

    .panel::before {
      inset: 8px;
      border-radius: 6px;
    }

    .panel::after {
      inset: 0;
      border-width: 0 0 2px 0;
      border-color: rgba(0, 0, 0, 0.8);
    }

    .title {
      font-size: 22px;
      color: #ffd100;
      text-align: center;
      margin: 0 0 10px;
      letter-spacing: 1px;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #c0b89a;
      margin-bottom: 18px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      justify-content: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      min-width: 220px;
    }

    .control-label {
      font-size: 12px;
      color: #e3dfc6;
      margin-bottom: 4px;
    }

    .control-input,
    .control-select {
      background: rgba(10, 8, 20, 0.95);
      border: 1px solid #c79c37;
      color: #f5f4e8;
      padding: 6px 10px;
      border-radius: 4px;
      outline: none;
      font-size: 13px;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .control-input:focus,
    .control-select:focus {
      border-color: #f8e39a;
      box-shadow: 0 0 6px rgba(248, 227, 154, 0.65);
      background: rgba(18, 14, 35, 0.98);
    }

    .table-wrapper {
      margin-top: 8px;
      border: 1px solid #c79c37;
      border-radius: 4px;
      background: linear-gradient(180deg, #070611, #05040b);
      max-height: 540px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 800px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    thead tr {
      background: linear-gradient(180deg, #403016, #24170a);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(70, 58, 32, 0.7);
      text-align: left;
      white-space: nowrap;
    }

    th {
      color: #ffe8b3;
      font-weight: 600;
      border-right: 1px solid rgba(120, 95, 45, 0.8);
    }

    th:last-child,
    td:last-child {
      border-right: none;
    }

    tbody tr:nth-child(even) {
      background: rgba(20, 13, 32, 0.75);
    }

    tbody tr:nth-child(odd) {
      background: rgba(9, 7, 18, 0.9);
    }

    tbody tr:hover {
      background: rgba(80, 60, 30, 0.65);
    }

    .instance-name {
      color: #ffd100;
    }

    .boss-name {
      color: #f0e6d2;
    }

    .item-name {
      font-weight: 600;
      cursor: default;
    }

    .item-epic {
      color: #a335ee; /* 史诗 紫色 */
    }

    .item-rare {
      color: #0070dd; /* 精良 蓝色 */
    }

    .item-uncommon {
      color: #1eff00; /* 优秀 绿色 */
    }

    .item-common {
      color: #ffffff; /* 普通 白色 */
    }

    .item-poor {
      color: #9d9d9d; /* 粗糙 灰色 */
    }

    .quality-epic {
      color: #a335ee;
    }

    .quality-rare {
      color: #0070dd;
    }

    .quality-uncommon {
      color: #1eff00;
    }

    .quality-common {
      color: #ffffff;
    }

    .quality-poor {
      color: #9d9d9d;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(40, 32, 18, 0.9);
      border: 1px solid rgba(199, 156, 55, 0.65);
      font-size: 11px;
      color: #e3dfc6;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: #9a9278;
      text-align: right;
    }

    @media (max-width: 768px) {
      .panel {
        padding: 16px 14px 20px;
      }
      .title {
        font-size: 18px;
      }
      .subtitle {
        font-size: 12px;
      }
      .control-group {
        min-width: 100%;
      }
      table {
        font-size: 12px;
        min-width: 700px;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="panel">
      <h1 class="title">时光泰坦重铸 副本掉落总览</h1>
      <div class="subtitle">
        Altasloot 全量掉落（物品属性来自本地数据库 tempest_keep_db.json）
      </div>

      <div class="controls">
        <div class="control-group">
          <label class="control-label" for="searchInput">装备名称搜索</label>
          <input
            id="searchInput"
            class="control-input"
            type="text"
            placeholder="输入装备名称关键字（支持模糊匹配）"
          />
        </div>
        <div class="control-group">
          <label class="control-label" for="instanceSelect">按副本筛选</label>
          <select id="instanceSelect" class="control-select">
            <option value="">全部副本</option>
            <!-- 动态填充 -->
          </select>
        </div>
        <div class="control-group">
          <label class="control-label" for="classSelect">按职业筛选可用掉落</label>
          <select id="classSelect" class="control-select">
            <option value="">全部职业</option>
            <option value="Warrior">战士</option>
            <option value="Paladin">圣骑士</option>
            <option value="Hunter">猎人</option>
            <option value="Rogue">潜行者</option>
            <option value="Priest">牧师</option>
            <option value="Shaman">萨满祭司</option>
            <option value="Mage">法师</option>
            <option value="Warlock">术士</option>
            <option value="Druid">德鲁伊</option>
            <option value="Death Knight">死亡骑士</option>
          </select>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>副本</th>
              <th>Boss</th>
              <th>物品名称</th>
              <th>品质</th>
              <th>物品等级</th>
              <th>适用职业</th>
              <th>备注</th>
            </tr>
          </thead>
          <tbody id="lootTableBody">
            <!-- JS 动态填充 -->
          </tbody>
        </table>
      </div>

      <div class="footer-note">
        数据来源：Altasloot + 本地数据库。物品链接指向 TitanReforged 数据库。
      </div>
    </div>
  </div>

  <script>
    // 从 Altasloot 源数据动态读取并转换为前端用的掉落表
    let lootData = [];
    let instanceList = []; // 副本列表
    let itemsDatabase = {}; // 本地物品数据库
    const itemCache = {}; // 缓存物品信息
    
    // 只显示这些副本
    const ALLOWED_INSTANCES = ['MoltenCore', 'SerpentshrineCavern', 'TempestKeep'];

    // 加载本地物品数据库
    async function loadItemsDatabase() {
      try {
        const response = await fetch('data/items.json');
        if (response.ok) {
          itemsDatabase = await response.json();
          console.log(`✅ Loaded ${Object.keys(itemsDatabase).length} items from local database`);
          return true;
        }
      } catch (e) {
        console.warn('Failed to load local items database:', e);
      }
      return false;
    }

    // 从本地数据库获取物品信息
    function getItemFromDatabase(itemId) {
      const item = itemsDatabase[itemId] || itemsDatabase[itemId.toString()];
      if (!item) return null;
      
      return {
        name: item.nameCn || item.name || `物品ID ${itemId}`,
        quality: item.quality || 1,
        qualityName: mapQualityName(item.quality),
        qualityNum: item.quality || 1,
        itemLevel: item.itemLevel || null,
        allowableClass: item.allowableClassText || '',
      };
    }

    // 品质映射函数
    function mapQualityName(quality) {
      const map = {
        0: "粗糙",
        1: "普通",
        2: "优秀",
        3: "精良",
        4: "史诗",
        5: "传说",
        6: "神器",
        7: "传家宝",
      };
      return map[quality] || "普通";
    }

    function mapQualityToClass(quality) {
      const map = {
        0: "poor",
        1: "common",
        2: "uncommon",
        3: "rare",
        4: "epic",
        5: "legendary",
        6: "artifact",
        7: "heirloom",
      };
      return map[quality] || "common";
    }

    // 批量获取物品信息（从本地数据库）
    async function batchFetchItemInfo(itemIds) {
      const results = {};
      
      itemIds.forEach(itemId => {
        const itemData = getItemFromDatabase(itemId);
        if (itemData) {
          results[itemId] = {
            name: itemData.name,
            quality: mapQualityToClass(itemData.quality),
            qualityName: itemData.qualityName,
            qualityNum: itemData.qualityNum,
            itemLevel: itemData.itemLevel,
            allowableClass: itemData.allowableClass,
          };
        } else {
          // 如果数据库中没有，返回默认值
          results[itemId] = {
            name: `物品ID ${itemId}`,
            quality: "common",
            qualityName: "普通",
            qualityNum: 1,
            itemLevel: null,
          };
        }
      });
      
      return results;
    }

    async function loadAtlasLootData() {
      const tbody = document.getElementById("lootTableBody");
      if (!tbody) return;

      // 简单的“加载中”提示
      tbody.innerHTML = "";
      const loadingTr = document.createElement("tr");
      const loadingTd = document.createElement("td");
      loadingTd.colSpan = 7;
      loadingTd.style.textAlign = "center";
      loadingTd.style.padding = "14px 8px";
      loadingTd.textContent = "正在加载本地数据库...";
      loadingTr.appendChild(loadingTd);
      tbody.appendChild(loadingTr);

      try {
        // 先加载本地物品数据库
        const dbLoaded = await loadItemsDatabase();
        if (!dbLoaded) {
          throw new Error("无法加载本地物品数据库");
        }

        loadingTd.textContent = "正在从 Altasloot 读取数据，请稍候……";
        // 从所有源文件加载数据
        const sourceFiles = [
          "Altasloot/AtlasLootMY_Data/source.lua",
          "Altasloot/AtlasLootMY_Data/source-tbc.lua",
          "Altasloot/AtlasLootMY_Data/source-wrath.lua"
        ];
        
        let allParsed = [];
        let allAtlasIds = [];

        for (const sourceFile of sourceFiles) {
          try {
            const res = await fetch(sourceFile);
            const text = await res.text();

            // 解析 ["AtlasLootIDs"] 区块
            const atlasIdsMatch = text.match(/\["AtlasLootIDs"\]\s*=\s*\{([\s\S]*?)\}/);
            const currentAtlasIds = [];
            if (atlasIdsMatch) {
              const idsBody = atlasIdsMatch[1];
              let m;
              const regex = /"([^"]+)"/g;
              while ((m = regex.exec(idsBody)) !== null) {
                currentAtlasIds.push(m[1]);
              }
            }
            allAtlasIds = allAtlasIds.concat(currentAtlasIds);

            // 解析 ["ItemData"]
            const itemDataMatch = text.match(/\["ItemData"\]\s*=\s*\{([\s\S]*?)\n\}/);
            if (!itemDataMatch) continue;
            
            const itemBody = itemDataMatch[1];
            const lineRegex = /\[(\d+)\]\s*=\s*(\{[\s\S]*?\}),?/g;
            let match;

            while ((match = lineRegex.exec(itemBody)) !== null) {
              const itemId = parseInt(match[1], 10);
              const raw = match[2].trim();

              let tupleText = raw;
              if (tupleText.startsWith("{{")) {
                const firstTuple = tupleText.match(/\{\s*([^{}]+?)\s*[,}]/);
                if (!firstTuple) continue;
                tupleText = "{" + firstTuple[1] + "}";
              }

              const nums = [];
              const numRegex = /(-?\d+)/g;
              let nm;
              while ((nm = numRegex.exec(tupleText)) !== null) {
                nums.push(parseInt(nm[1], 10));
              }

              if (nums.length < 2) continue;

              const instIdx = nums[0];
              const bossIdx = nums[1];
              const instanceKey =
                instIdx >= 1 && instIdx <= currentAtlasIds.length
                  ? currentAtlasIds[instIdx - 1]
                  : `UnknownInstance#${instIdx}`;

              allParsed.push({
                instance: instanceKey,
                boss: `Boss #${bossIdx}`,
                itemId,
              });
            }
          } catch (e) {
            console.warn(`加载 ${sourceFile} 失败:`, e);
          }
        }

        instanceList = allAtlasIds;

        // 填充副本下拉框（显示允许的副本）
        const instanceSelect = document.getElementById("instanceSelect");
        if (instanceSelect) {
          instanceSelect.innerHTML = '<option value="">全部副本</option>';
          ALLOWED_INSTANCES.forEach((instance) => {
            if (allAtlasIds.includes(instance)) {
              const option = document.createElement("option");
              option.value = instance;
              option.textContent = instance;
              instanceSelect.appendChild(option);
            }
          });
        }

        // 过滤只保留允许的副本
        const filteredParsed = allParsed.filter(row => 
          ALLOWED_INSTANCES.includes(row.instance)
        );

        // 先创建基础数据结构
        lootData = filteredParsed.map((row) => ({
          instance: row.instance,
          boss: row.boss,
          itemId: row.itemId,
          itemName: `物品ID ${row.itemId}`,
          quality: "common", // 默认值，稍后更新
          qualityName: "普通",
          qualityNum: 1,
          itemLevel: null,
          classes: [],
          note: `Altasloot ID: ${row.itemId}`,
          loaded: false, // 标记是否已加载详细信息
        }));

        // 批量获取物品信息（从本地数据库）
        const itemIds = lootData.map((item) => item.itemId);
        const itemInfos = await batchFetchItemInfo(itemIds);

        // 更新加载提示
        loadingTd.textContent = `正在处理 ${itemIds.length} 个物品...`;

        // 更新物品信息
        lootData.forEach((item) => {
          const info = itemInfos[item.itemId];
          if (info) {
            item.itemName = info.name;
            item.quality = info.quality;
            item.qualityName = info.qualityName;
            item.qualityNum = info.qualityNum;
            item.itemLevel = info.itemLevel;
            item.loaded = true;
          }
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = "";
        const errTr = document.createElement("tr");
        const errTd = document.createElement("td");
        errTd.colSpan = 7;
        errTd.style.textAlign = "center";
        errTd.style.padding = "14px 8px";
        errTd.textContent =
          "加载失败！请检查：1) Altasloot 目录结构正确；2) data/items.json 存在。";
        errTr.appendChild(errTd);
        tbody.appendChild(errTr);
        return;
      }

      // 数据准备好后重新渲染表格
      renderTable();
    }

    const tbody = document.getElementById("lootTableBody");
    const searchInput = document.getElementById("searchInput");
    const classSelect = document.getElementById("classSelect");
    const instanceSelect = document.getElementById("instanceSelect");

    function renderTable() {
      const keyword = searchInput.value.trim().toLowerCase();
      const selectedClass = classSelect.value;
      const selectedInstance = instanceSelect.value;

      tbody.innerHTML = "";

      const filtered = lootData.filter((item) => {
        const nameMatch =
          !keyword ||
          item.itemName.toLowerCase().includes(keyword) ||
          item.boss.toLowerCase().includes(keyword) ||
          item.instance.toLowerCase().includes(keyword);

        const instanceMatch =
          !selectedInstance || item.instance === selectedInstance;

        const classMatch =
          !selectedClass ||
          (Array.isArray(item.classes) &&
            item.classes.some((c) =>
              c.toLowerCase().includes(selectedClass.toLowerCase())
            ));

        return nameMatch && instanceMatch && classMatch;
      });

      filtered.forEach((item) => {
        const tr = document.createElement("tr");

        const tdInstance = document.createElement("td");
        tdInstance.textContent = item.instance;
        tdInstance.className = "instance-name";
        tr.appendChild(tdInstance);

        const tdBoss = document.createElement("td");
        tdBoss.textContent = item.boss;
        tdBoss.className = "boss-name";
        tr.appendChild(tdBoss);

        const tdItem = document.createElement("td");
        const itemLink = document.createElement("a");
        const itemId = item.itemId;

        itemLink.textContent = item.itemName;
        itemLink.classList.add("item-name");
        itemLink.href = itemId
          ? `https://wlk.scarlet5.com/?search=${itemId}`
          : "javascript:void(0)";
        itemLink.target = "_blank";

        // Wowhead tooltip 联动（依赖下面引入的 power.js）
        if (itemId) {
          itemLink.setAttribute("data-wowhead", `item=${itemId}`);
        }

        // 根据品质添加样式
        if (item.quality === "epic") {
          itemLink.classList.add("item-epic");
        } else if (item.quality === "rare") {
          itemLink.classList.add("item-rare");
        } else if (item.quality === "uncommon") {
          itemLink.classList.add("item-uncommon");
        } else if (item.quality === "common") {
          itemLink.classList.add("item-common");
        } else if (item.quality === "poor") {
          itemLink.classList.add("item-poor");
        }

        tdItem.appendChild(itemLink);
        tr.appendChild(tdItem);

        const tdQuality = document.createElement("td");
        tdQuality.textContent = item.qualityName || "普通";
        tdQuality.classList.add(`quality-${item.quality || "common"}`);
        tr.appendChild(tdQuality);

        const tdIlvl = document.createElement("td");
        tdIlvl.textContent =
          typeof item.itemLevel === "number" ? item.itemLevel : "—";
        tr.appendChild(tdIlvl);

        const tdClasses = document.createElement("td");
        tdClasses.textContent = Array.isArray(item.classes)
          ? item.classes.join(", ")
          : "";
        tr.appendChild(tdClasses);

        const tdNote = document.createElement("td");
        if (item.note) {
          const tag = document.createElement("span");
          tag.className = "tag";
          tag.textContent = item.note;
          tdNote.appendChild(tag);
        }
        tr.appendChild(tdNote);

        tbody.appendChild(tr);
      });

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.style.textAlign = "center";
        td.style.padding = "14px 8px";
        td.textContent = "当前筛选条件下没有找到掉落数据。";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    searchInput.addEventListener("input", renderTable);
    classSelect.addEventListener("change", renderTable);
    if (instanceSelect) {
      instanceSelect.addEventListener("change", renderTable);
    }

    // 页面加载后，先从 Altasloot 读取数据，再渲染表格
    window.addEventListener("DOMContentLoaded", () => {
      loadAtlasLootData();
    });
  </script>
</body>
</html>
